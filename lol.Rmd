---
title: "League of Legends Data Analysis"
author: "Vincent Quenneville-BÃ©lair"
date: "March, 2016"
output: html_document
---

Loading packages.
```{r}
# https://cran.r-project.org/web/packages/tidyjson/vignettes/introduction-to-tidyjson.html
# https://github.com/sailthru/tidyjson
library("tidyjson")

library(plyr)
library(tidyr)
library(dplyr)
library(stringr)

library(ggplot2)
library(rattle)

library(caret)
library(pROC)
```

```{r}
# Read RIOT API key
# riot.key <- readLines("riot.key")
# options("riot.key" = riot.key)
```

Load match file.
```{r}
# TidyJSON
data.file <- "data/matches1.json"
# data.file <- "data/matches_all.json"
data.json <- read_json(data.file)
```

Load information from each match.
```{r}
data.match <- data.json %>% 
  # gather_array("file.index") %>%
  enter_object("matches") %>%
  gather_array("matches.index") %>% 
  spread_values(matchId = jnumber("matchId")) %>%
  select(matchId) %>%
  spread_values(mapId = jnumber("mapId"),
                matchDuration = jnumber("matchDuration"),
                matchMode = jstring("matchMode"),
                matchType = jstring("matchType"),
                queueType = jstring("queueType"),
                region = jstring("region"))

data.match %>%
  filter(matchId == 2054994244) %>%
  head()
```

We make the table of winner per match.
```{r}
match.winner <- data.match %>%
  select(matchId) %>%
  enter_object("teams") %>%
  gather_array("teams.index") %>% 
  spread_values(teamId = jnumber("teamId"),
                winner = jlogical("winner")) %>%
  select(-teams.index) %>%
  mutate(winner = winner * teamId) %>%
  group_by(matchId) %>%
  summarise_each(funs(sum)) %>%
  select(-teamId) %>%
  mutate_each(funs(factor))

# Is there an advantage being on the blue/red side?
match.winner %>% 
  select(winner) %>%
  summary()
```

```{r}
match.events <- data.match %>%
  enter_object("timeline") %>%
  enter_object("frames") %>%
  gather_array("frames.index") %>%
  enter_object("events") %>%
  gather_array("events.index") %>%
  select(matchId) %>%
  spread_values(eventType = jstring("eventType"),
                participantId = jnumber("participantId"), 
                timestamp = jnumber("timestamp"),
                creatorId = jnumber("creatorId"),
                teamId = jnumber("teamId"))
                
# Extract tower information to infer whether losing team surrendered
match.events <- match.events %>%
  spread_values(towerType = jstring("towerType"))

match.events <- merge(match.events, match.winner, by = "matchId")

math.surrender <- match.events %>%
  filter(towerType == "NEXUS_TURRET") %>%
  select(matchId, teamId, winner, towerType) %>%
  mutate(NEXUS_TURRET = 1) %>%
  select(-towerType) %>%
  group_by(matchId, teamId, winner) %>%
  summarise_each(funs(sum)) %>%
  mutate(surrender = ifelse(teamId == winner, FALSE, ifelse(NEXUS_TURRET < 2, TRUE, FALSE))) %>%
  select(-winner, -NEXUS_TURRET)

# How many matches ended in surrender?
x <- math.surrender$surrender
sum(x)
# Percent of matches that ended in surrender?
sum(x) / length(x) * 100
```

Helper functions for manipulating columns.
```{r}
# Convert to numeric
convert.numeric <- function(x) {
  as.numeric(as.character(x))
}

# Remove incomplete cases
complete.remove <- function(x) {
  x <- x[complete.cases(x),]  
}

# Convert to string without factors
convert.char <- function(x) {
  data.frame(lapply(x, as.character), stringsAsFactors=FALSE) 
}
```

```{r}
# Delta fields refer to values for the specified period (e.g., the gold per minute over the first 10 minutes of the game versus the second 20 minutes of the game) 
# Diffs fields refer to the deltas versus the calculated lane opponent(s)

timeline <- data.match %>%
  enter_object("participants") %>%
  gather_array("participants.index") %>%
  spread_values(teamId = jnumber("teamId")) %>%
  enter_object("timeline")

participants_creeps <- timeline %>% 
  enter_object("creepsPerMinDeltas") %>%
  gather_keys("ParticipantTimelineData") %>%
  append_values_number("creepsPerMinDeltas")

participants_gold <- timeline %>% 
  enter_object("goldPerMinDeltas") %>%
  gather_keys("ParticipantTimelineData") %>%
  append_values_number("goldPerMinDeltas")

# participants_wards <- timeline %>% 
#   enter_object("wardsPerMinDeltas") %>%
#   gather_keys("ParticipantTimelineData") %>%
#   append_values_number("ParticipantTimelineValue")

participants_xp <- timeline %>% 
  enter_object("xpPerMinDeltas") %>%
  gather_keys("ParticipantTimelineData") %>%
  append_values_number("xpPerMinDeltas")

participants <- cbind(participants_creeps, participants_gold$goldPerMinDeltas, participants_xp$xpPerMinDeltas)
names(participants)[12] <- "goldPerMinDeltas"
names(participants)[13] <- "xpPerMinDeltas"

participants <- merge(participants, team, by = "matchId") %>%
  group_by(matchId, teamId, ParticipantTimelineData) %>%
  summarise_each(funs(mean), matchId, teamId,
                 ParticipantTimelineData, creepsPerMinDeltas, goldPerMinDeltas, xpPerMinDeltas)
```