---
title: "League of Legends Data Analysis"
author: "Vincent Quenneville-BÃ©lair"
date: "March, 2016"
output: html_document
---

Loading packages.
```{r}
library("rjson")
# library("jsonlite")
# https://cran.r-project.org/web/packages/tidyjson/vignettes/introduction-to-tidyjson.html
# library("tidyjson")

library(plyr)
library(tidyr)
library(dplyr)
library(stringr)

library(png)
library(grid)
library(ggplot2)
```

Test opening of similar data.
```{r}
# http://stackoverflow.com/questions/27430042/parse-nested-json-to-data-frame-in-r

data.file <- "data/HQDf2ase.txt"
data.json <- fromJSON(file = data.file)
data.unlist <- lapply(data.json$matches, unlist)

convert.list <- function(x){
  do.call("data.frame", as.list(x))
}

ptm <- proc.time()
data.match <- rbind.fill(lapply(data.unlist, convert.list))
proc.time() - ptm

data.frame <- as.data.frame(data.match)
```

Load one match file.
```{r}
data.file <- paste("data/matches", 1, ".json", sep = "")
# data.json <- fromJSON(file = data.file)
data.json <- fromJSON(txt = data.file)  # jsonlite
data.unlist <- lapply(data.json$matches, unlist)

funct <- function(x){
  do.call("data.frame", as.list(x))
}

ptm <- proc.time()
data.match <- rbind.fill(lapply(data.unlist, funct))
proc.time() - ptm

data.frame <- as.data.frame(data.match)
```

Load all 10 files.
```{r}
# for (i in 1:10) {
#   json_file <- paste("data/matches", i, ".json", sep = "")
# 	json_data <- fromJSON(file=json_file)
# }
```

```{r}
# Save column names
names(data.frame) %>% write(file = "names")
```

We plot the events of a match.
```{r}
convert.numeric <- function(x) {
  as.numeric(as.character(x))
}

complete.remove <- function(x) {
  x <- x[complete.cases(x),]  
}

coord <- data.frame %>% 
  filter(matchId == 2054994244) %>%
  select(starts_with("timeline.frames.events.position.")) %>%
  lapply(convert.numeric) %>%
  as.data.frame() %>%
  gather(key = timeline.frames.events.position, value = coordinate) %>%
  mutate(timeline.frames.events.position = 
           str_replace_all(timeline.frames.events.position, 
                           "timeline.frames.events.position.", "")) %>%
  separate("timeline.frames.events.position", c("axis", "ID"))

# Fill IDs
coord$ID[is.na(coord$ID)] <- 0
# Remove incompletes
coord <- coord[complete.cases(coord),]

tail(coord)

coord <- coord %>%
  spread(axis, coordinate) %>%
  select(-ID)

# Map dimensions
# min: {x: 0, y: 0}
# max: {x: 14820, y: 14881}

f.x <- function(x) {
  # Input:
  # min: {x: -570, y: -420}
  # max: {x: 15220, y: 14980}
  # Output:
  # min: {x: 0, y: 0}
  # max: {x: 512, y: 512}
  
  i.xmin = -570
  i.xmax = 15220
  o.xmin = 0
  o.xmax = 512
  
  x <- o.xmin + (o.xmax - o.xmin) * (x - i.xmin) / (i.xmax - i.xmin)

  return(x)
}

f.y <- function(y) {
  # Input:
  # min: {x: -570, y: -420}
  # max: {x: 15220, y: 14980}
  # Output:
  # min: {x: 0, y: 0}
  # max: {x: 512, y: 512}
  
  i.ymin = -420
  i.ymax = 14980
  o.ymin = 0
  o.ymax = 512
  
  y <- o.ymin + (o.ymax - o.ymin) * (y - i.ymin) / (i.ymax - i.ymin)
  
  return(y)
}

# Get background image
img <- readPNG("data/minimap-mh.png")
g <- rasterGrob(img, interpolate=TRUE, width=unit(1,"npc"), height=unit(1,"npc"))

# Scatter plot with background
p <- ggplot(coord, aes(f.x(x), f.y(y))) + 
  annotation_custom(g, xmin=0, xmax=512, ymin=0, ymax=512) +
  geom_point(alpha = 0.5, size = 3) +
  expand_limits(x = c(0,512), y = c(0,512))

# Remove padding and decorations
p <- p +
  scale_y_continuous(expand = c(0,0)) + 
  scale_x_continuous(expand = c(0,0)) +
  theme(axis.line=element_blank(),
          axis.text.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          panel.background=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.background=element_blank())

# Show and save plot
print(p)
ggsave("figures/events.png", dpi = 51.2, width = 10, height = 10, units = "in")
```

```{r}
#   filter(timeline.frames.events.eventType == "CHAMPION_KILL") %>%
#   select(contains = "tenToTwenty") %>%
#   colSums()
```
