---
title: "League of Legends Data Analysis"
author: "Vincent Quenneville-BÃ©lair"
date: "March, 2016"
output: html_document
---

Loading packages.
```{r}
# https://cran.r-project.org/web/packages/tidyjson/vignettes/introduction-to-tidyjson.html
# https://github.com/sailthru/tidyjson
library("tidyjson")

library(plyr)
library(tidyr)
library(dplyr)
library(stringr)

library(png)
library(grid)
library(ggplot2)
```

```{r}
# Read RIOT API key
# riot.key <- readLines("riot.key")
# options("riot.key" = riot.key)
```

Load all 10 files.
```{r}
for (i in 1:10) {
  json.file <- paste("data/matches", i, ".json", sep = "")
  json.data <- read_json(json_file)
}
```

Load one match file.
```{r}
# TidyJSON
data.file <- paste("data/matches", 1, ".json", sep = "") 
data.json <- read_json(data.file)
```

Make data frame for first objectives.
```{r}
first <- data.json %>% 
  enter_object("matches") %>%
  gather_array("matches.index") %>% 
  spread_values(matchId = jstring("matchId")) %>%
  enter_object("teams") %>%
  gather_array("teams.index") %>% 
  spread_values(
    winner = jstring("winner"),
    firstBaron = jstring("firstBaron"),
    firstBlood = jstring("firstBlood"),
    firstDragon = jstring("firstDragon"),
    firstInhibitor = jstring("firstInhibitor"),
    firstRiftHerald = jstring("firstRiftHerald"))
```

```{r}
contract <- function(x) {
  paste(x, collapse = ' ')
} 

events <- data.json %>%
  enter_object("matches") %>%
  gather_array("matches.index") %>%
  spread_values(matchId = jstring("matchId")) %>%
  enter_object("timeline") %>%
  enter_object("frames") %>%
  gather_array("frames.index") %>%
  enter_object("events") %>%
  gather_array("events.index") %>%
  spread_values(eventType = jstring("eventType"),
                position = jstring("position"), 
                teamId = jstring("teamId"),
                participantId = jstring("participantId"), 
                timestamp = jstring("timestamp")) %>%
  mutate(position = sapply(str_extract_all(position, "[[:digit:]]+"), contract)) %>%
  as.data.frame() %>%
  separate(position, c("X", "Y")) %>%
  mutate(X = as.numeric(X),
         Y = as.numeric(Y))

summary(as.factor(events$eventType))
```

Helper functions for manipulating columns.
```{r}
# Convert to numeric
convert.numeric <- function(x) {
  as.numeric(as.character(x))
}

# Remove incomplete cases
complete.remove <- function(x) {
  x <- x[complete.cases(x),]  
}

# Convert to string without factors
convert.char <- function(x) {
  data.frame(lapply(x, as.character), stringsAsFactors=FALSE) 
}
```

We plot the events of a match.
```{r}
# We need to apply a linear transformation 
# mapping the given coordinates to the corresponding pixels on the image

# Coordinate range in data frame
# min: {x: 0, y: 0}
# max: {x: 14820, y: 14881}
# Coordinate range on map
# min: {x: -570, y: -420}
# max: {x: 15220, y: 14980}
# Image pixel coordinates
# min: {x: 0, y: 0}
# max: {x: 512, y: 512}

f.x <- function(x) {
  # Input range -570 to 15220
  # Output range 0 to 512
  
  i.xmin = -570
  i.xmax = 15220
  o.xmin = 0
  o.xmax = 512
  
  o.xmin + (o.xmax - o.xmin) * (x - i.xmin) / (i.xmax - i.xmin)
}

f.y <- function(y) {
  # Input range -420 to 14980
  # Output range 0 to 512
  
  i.ymin = -420
  i.ymax = 14980
  o.ymin = 0
  o.ymax = 512
  
  o.ymin + (o.ymax - o.ymin) * (y - i.ymin) / (i.ymax - i.ymin)
}

# Extract the positions of all events in a given match
# ... and apply transformation to find corresponding pixel on image
coord <- events %>% 
  filter(matchId == 2054994244) %>%
  select(X, Y) %>%
  na.omit() %>%
  select(X, Y) %>%
  mutate(X = f.x(X), Y = f.y(Y))  # Apply linear transformation

# Get background image
img <- readPNG("data/minimap-mh.png")
g <- rasterGrob(img, interpolate=TRUE, width=unit(1,"npc"), height=unit(1,"npc"))

# Scatter plot with background
p <- ggplot(coord, aes(X, Y)) + 
  annotation_custom(g, xmin = 0, xmax = 512, ymin = 0, ymax = 512) +
  geom_point(alpha = 0.5, size = 3) +
  expand_limits(x = c(0,512), y = c(0,512))

# Remove padding and decorations
p <- p +
  scale_y_continuous(expand = c(0,0)) + 
  scale_x_continuous(expand = c(0,0)) +
  theme(axis.line=element_blank(),
          axis.text.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          panel.background=element_blank(),
          panel.border=element_blank(),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          plot.background=element_blank())

# Show and save plot
print(p)
ggsave("figures/events.png", dpi = 51.2, width = 10, height = 10, units = "in")
```

```{r}
# Regular expression to match numbers
# http://stackoverflow.com/questions/15451251/extract-numeric-part-of-strings-of-mixed-numbers-and-characters-in-r
regexp <- "[[:digit:]]+"

# Extract event type for each event
events.type <- data.frame %>% 
  filter(matchId == 2054994244) %>%
  select(starts_with("timeline.frames.events.")) %>%
  convert.char() %>%
  gather(key = ID, value = eventType, 
         starts_with("timeline.frames.events.eventType")) %>%
  mutate(ID = str_extract(eventType, regexp)) %>% 
  mutate(ID = fill.na(ID)) %>%  # Fill IDs
  mutate(ID = as.numeric(ID)) %>%
  na.omit()

# Find how many of each event type
summary(as.factor(events.type$eventType))

# BUILDING_KILL      CHAMPION_KILL ELITE_MONSTER_KILL     ITEM_DESTROYED     ITEM_PURCHASED
#            17                110                  6                215                289
#     ITEM_SOLD          ITEM_UNDO     SKILL_LEVEL_UP          WARD_KILL        WARD_PLACED
#            11                  5                180                  5                447 
```

```{r}
# Extract event participant for each event
events.partipant <- data.frame %>% 
  filter(matchId == 2054994244) %>%
  select(starts_with("timeline.frames.events.participantId")) %>%
  convert.char() %>%
  gather(key = ID, value = participant) %>%
  mutate(ID = str_extract(ID, regexp)) %>% 
  mutate(ID = fill.na(ID)) %>%  # Fill IDs
  mutate(ID = as.numeric(ID)) %>%
  na.omit()

# Extract event time for each event
events.partipant <- data.frame %>% 
  filter(matchId == 2054994244) %>%
  select(starts_with("timeline.frames.events.timestamp")) %>%
  convert.char() %>%
  gather(key = ID, value = timestamp) %>%
  mutate(ID = str_extract(ID, regexp)) %>% 
  mutate(ID = fill.na(ID)) %>%  # Fill IDs
  mutate(ID = as.numeric(ID)) %>%
  na.omit()
```

```{r}
# Extract event type for each event
timeline <- data.frame %>% 
  filter(matchId == 2054994244) %>%
  select(starts_with("timeline.frames.events")) %>%
  convert.char() %>%
  gather(key = TypeMomentID, value = Number) %>%
  mutate(TypeMomentID = 
         str_replace_all(TypeMomentID, "participants.timeline.", "")) %>%
  separate("TypeMomentID", c("Type", "Moment", "ID")) %>%
  mutate(ID = as.numeric(ID)) %>%
  mutate(Number = as.numeric(Number)) %>%
  mutate(ID = fill.na(ID)) %>%  # Fill IDs
  na.omit()
```

```{r}
coord <- data.frame %>% 
  filter(matchId == 2054994244) %>%
  gather(key = timeline.frames.events.position, value = coordinate) %>%
  mutate(timeline.frames.events.position = 
           str_replace_all(timeline.frames.events.position, 
                           "timeline.frames.events.position.", "")) %>%
  separate("timeline.frames.events.position", c("axis", "ID")) %>%
  mutate(ID = fill.na(ID)) %>%  # Fill IDs
  na.omit() %>%
  spread(axis, coordinate) %>%
  select(-ID) %>%
```
