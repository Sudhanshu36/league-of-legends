---
title: "League of Legends Data Analysis"
author: "Vincent Quenneville-BÃ©lair"
date: "March, 2016"
output: html_document
---

Loading packages.
```{r}
# https://cran.r-project.org/web/packages/tidyjson/vignettes/introduction-to-tidyjson.html
# https://github.com/sailthru/tidyjson
library("tidyjson")

library(plyr)
library(magrittr)
library(tidyr)
library(dplyr)
library(stringr)

library(ggplot2)
library(rattle)

library(caret)
library(pROC)
```

```{r}
# Read RIOT API key
# riot.key <- readLines("riot.key")
# options("riot.key" = riot.key)
```

Load match file.
```{r}
# TidyJSON
# data.file <- "data/matches1.json"
data.file <- "data/matches_all.json"
data.json <- read_json(data.file)
```

Load match data.
```{r}
data.match <- data.json %>% 
  gather_array("file.index") %>%
  enter_object("matches") %>%
  gather_array("matches.index") %>% 
  spread_values(matchId = jnumber("matchId")) %>%
  select(matchId) 

# Print general match information
data.match %>%
  spread_values(mapId = jnumber("mapId"),
                matchDuration = jnumber("matchDuration"),
                matchMode = jstring("matchMode"),
                matchType = jstring("matchType"),
                queueType = jstring("queueType"),
                region = jstring("region"),
                season = jstring("season")) %>%
  head()
```

Match duration
```{r}
data.match %>%
  spread_values(matchDuration = jnumber("matchDuration")) %>%
  mutate(matchDuration = matchDuration/60) %>%
  select(matchDuration) %>%
  summary

#  matchDuration  
#  Min.   :27.33  
#  1st Qu.:31.83  
#  Median :35.01  
#  Mean   :35.99  
#  3rd Qu.:38.62  
#  Max.   :52.15  

match.duration <- data.match %>%
  spread_values(matchDuration = jnumber("matchDuration")) %>%
  mutate(matchDuration = matchDuration/60) 

summary(match.duration$matchDuration/60)
```


We make a data frame for events.
```{r}
match.events <- data.match %>%
  enter_object("timeline") %>%
  enter_object("frames") %>%
  gather_array("frames.index") %>%
  enter_object("events") %>%
  gather_array("events.index") %>%
  select(matchId) %>%
  spread_values(eventType = jstring("eventType"),
                timestamp = jnumber("timestamp"),
                teamId = jnumber("teamId"),
                participantId = jnumber("participantId"), 
                creatorId = jnumber("creatorId"),
                victimId = jnumber("victimId"),
                killerId = jnumber("killerId"),
                monsterType = jstring("monsterType"),
                position = jstring("position"),
                towerType = jstring("towerType"),
                buildingType = jstring("buildingType")) %>%
  mutate(timestamp = timestamp/1000/60)
```

## Conditional Probabilities

We make the table of winner per match.
```{r}
# Extract per team information
data.team <- data.match %>%
  enter_object("teams") %>%
  gather_array("teams.index") %>% 
  spread_values(
    teamId = jnumber("teamId"),
    winner = jlogical("winner"),
    firstTower = jlogical("firstTower"),
    firstBaron = jlogical("firstBaron"),
    firstBlood = jlogical("firstBlood"),
    firstDragon = jlogical("firstDragon"),
    firstInhibitor = jlogical("firstInhibitor"),
    firstRiftHerald = jlogical("firstRiftHerald")) %>%
  select(-teams.index)

match.winner <- data.team
  select(matchId, teamId, winner)

# Is there an advantage being on the blue/red side?
match.winner %>%
  mutate(winner = winner * teamId) %>%
  group_by(matchId) %>%
  summarise_each(funs(sum)) %>%
  select(-teamId) %>%
  mutate_each(funs(factor)) %>% 
  select(winner) %>%
  summary()

#  winner  
#  100:53  
#  200:47  
```

Conditiontional probabilities on various objectives
```{r}
data.team %>%
  filter(firstBlood == TRUE) %>%
  select(winner) %>%
  summarise(sum(winner)/n() * 100)

#   sum(winner)/n() * 100
# 1                  61.1

data.team %>%
  filter(firstDragon == TRUE) %>%
  select(winner) %>%
  summarise(sum(winner)/n() * 100)

#   sum(winner)/n() * 100
# 1               69.4864

data.team %>%
  filter(firstTower == TRUE) %>%
  select(winner) %>%
  summarise(sum(winner)/n() * 100)

#   sum(winner)/n() * 100
# 1                  68.2

data.team %>%
  filter(firstRiftHerald == TRUE) %>%
  select(winner) %>%
  summarise(sum(winner)/n() * 100)

#   sum(winner)/n() * 100
# 1               74.4898

data.team %>%
  filter(firstBaron == TRUE) %>%
  select(winner) %>%
  summarise(sum(winner)/n() * 100)

#   sum(winner)/n() * 100
# 1              82.53425

data.team %>%
  filter(firstInhibitor == TRUE) %>%
  select(winner) %>%
  summarise(sum(winner)/n() * 100)

#   sum(winner)/n() * 100
# 1              90.59081
```

## Surrender 

Proportion of matches that ends in surrender. A team who lost and still had at least one Nexus tower surrendered. We assume all surrenders are as such.
```{r}
# Extract tower information to infer whether losing team surrendered
match.turret <- match.events %>%
  filter(towerType == "NEXUS_TURRET") %>%
  mutate(NEXUS_TURRET = 1) %>%
  select(matchId, teamId, NEXUS_TURRET)

match.surrender <- merge(match.winner, match.turret, all.x = TRUE) %>%
  group_by(matchId, teamId, winner) %>%
  summarise_each(funs(sum)) %>%
  mutate(surrender = ifelse(winner, FALSE, 
                            ifelse(NEXUS_TURRET < 2 | is.na(NEXUS_TURRET), TRUE, FALSE))) %>%
  group_by(matchId) %>%
  summarise_each(funs(sum)) %>%
  select(matchId, surrender) %>%
  mutate(surrender = as.logical(surrender))

timeline.surrender <- merge(match.duration, match.surrender) %>%
  group_by(surrender) %>%
  summarise_each(funs(median)) %>%
  mutate(eventType = ifelse(surrender, "SURRENDER", "CASTLE DESTRUCTION"),
         timestamp = matchDuration) %>%
  select(timestamp, eventType)

# Percent of matches that ended in surrender?
x <- match.surrender$surrender
print(sum(x) / length(x) * 100)
```

## Timeline

When are certain objectives achieved for the time in a match?
```{r}
# BARON_NASHOR, BLUE_GOLEM, DRAGON, RED_LIZARD, RIFTHERALD, VILEMAW
match.events %>%
  filter(monsterType == "DRAGON") %>%
  select(matchId, timestamp) %>%
  group_by(matchId) %>%
  mutate(rank = rank(timestamp, na.last = TRUE, ties.method = "first")) %>%
  filter(rank == 1) %>%
  select(-rank)

# Length of games
timeline.end <- match.duration %>%
  summarise(timestamp = median(matchDuration)) %>%
  mutate(eventType = "END")

# Compute median time when first tower is destroyed
timeline.tower <- match.events %>% 
  filter(eventType == "BUILDING_KILL") %>%
  select(matchId, timestamp) %>%
  group_by(matchId) %>%
  mutate(rank = rank(timestamp, na.last = TRUE, ties.method = "first")) %>%
  filter(rank == 1) %>%
  as.data.frame() %>%
  select(timestamp) %>%
  summarise_each(funs(median)) %>%
  mutate(eventType = "TOWER DESTRUCTION")

# Compute median time when first tower is destroyed
timeline.inhibitor <- match.events %>% 
  filter(buildingType == "INHIBITOR_BUILDING") %>%
  select(matchId, timestamp) %>%
  group_by(matchId) %>%
  mutate(rank = rank(timestamp, na.last = TRUE, ties.method = "first")) %>%
  filter(rank == 1) %>%
  as.data.frame() %>%
  select(timestamp) %>%
  summarise_each(funs(median)) %>%
  mutate(eventType = "INHIBITOR DESTRUCTION")

# Compute median time when first elite monster is killed
timeline.monster <- match.events %>%
  filter(eventType == "ELITE_MONSTER_KILL") %>%
  select(matchId, timestamp, monsterType) %>%
  group_by(matchId, monsterType) %>%
  mutate(rank = rank(timestamp, na.last = TRUE, ties.method = "first")) %>%
  filter(rank == 1) %>%
  as.data.frame() %>%
  select(timestamp, monsterType) %>%
  group_by(monsterType) %>%
  summarise_each(funs(median)) %>%
  mutate(eventType = monsterType) %>%
  select(-monsterType) %>%
  mutate(eventType = str_replace(eventType, "DRAGON", "DRAGON KILL"),
         eventType = str_replace(eventType, "BARON_NASHOR", "BARON KILL"),
         eventType = str_replace(eventType, "RIFTHERALD", "HERALD KILL"))

# Compute the median time to draw first blood
timeline.kill <- match.events %>%
  filter(eventType == "CHAMPION_KILL") %>% 
  select(matchId, timestamp) %>%
  group_by(matchId) %>%
  mutate(rank = rank(timestamp, na.last = TRUE, ties.method = "first")) %>%
  filter(rank == 1) %>%
  as.data.frame() %>%
  summarise(timestamp = median(timestamp)) %>%
  mutate(eventType = "CHAMPION KILL")

# Compute the median time to reach level 18
timeline.maxlvl <- match.events %>%
  filter(eventType == "SKILL_LEVEL_UP") %>%
  mutate(teamId = ifelse(participantId <= 5, 100, 200)) %>%
  select(matchId, timestamp, teamId) %>%
  group_by(matchId, teamId) %>%
  mutate(rank = rank(timestamp, na.last = TRUE, ties.method = "first")) %>%
  filter(rank == 5*18)

# Print proporitions of game reaching level 18
x <- length(unique(timeline.maxlvl$matchId))
n <- length(data.match$matchId)
print(x/n * 100)
# [1] 6.3

# Add to timeline
timeline.maxlvl <- timeline.maxlvl %>%
  as.data.frame() %>%
  summarise(timestamp = median(timestamp)) %>%
  mutate(eventType = "MAX LEVEL")

# Compute the median level reached
match.events %>%
  filter(eventType == "SKILL_LEVEL_UP") %>%
  mutate(teamId = ifelse(participantId <= 5, 100, 200)) %>%
  select(matchId, timestamp, teamId) %>%
  group_by(matchId, teamId) %>%
  mutate(rank = rank(timestamp, na.last = TRUE, ties.method = "first")) %>%
  select(-timestamp) %>%
  summarise_each(funs(max(rank))) %>%
  as.data.frame() %>%
  summarise(rank = median(rank)/5)

#   rank
# 1 15.5

timeline <- rbind(timeline.monster, timeline.kill, timeline.maxlvl, timeline.surrender, timeline.tower)
            # timeline.inhibitor
timeline <- timeline[order(timeline$timestamp),]

#   timestamp          eventType
#       (dbl)              (chr)
# 1  3.154658      CHAMPION KILL
# 2 12.928967        DRAGON KILL
# 3 16.296100        HERALD KILL
# 4 25.475000          SURRENDER
# 5 29.355583         BARON KILL
# 6 33.416667 CASTLE DESTRUCTION
# 7 44.567367          MAX LEVEL
  
# Draw timeline
# http://stackoverflow.com/questions/7492274/draw-a-chronological-timeline-with-ggplot2

# dislocations <- sample(c(-1,-.5,.5,1), dim(timeline)[1], replace = T)
dislocations <- c(1.0, -1.0, 0.5, -0.5, 1.0, -1.0, 0.5, -0.5)
nudges <- 0.1 * sign(dislocations)

p <- ggplot(timeline) + 
  geom_text(aes(x = timestamp, y = dislocations, label = eventType), 
            position = position_nudge(y = nudges)) +
  geom_hline(yintercept = 0, color = "purple") +
  geom_segment(aes(x = timestamp, y = dislocations, xend = timestamp, yend = 0)) +
  xlab("minutes") +
  scale_x_continuous(expand = c(.15, .15))

p <- p + 
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none")

print(p)
ggsave("figures/timeline.png", dpi = 100, width = 7, height = 4, units = "in")
```

## Scatter plot

```{r}
# Delta fields refer to values for the specified period (e.g., the gold per minute over the first 10 minutes of the game versus the second 20 minutes of the game) 
# Diffs fields refer to the deltas versus the calculated lane opponent(s)

participants.timeline <- data.match %>%
  enter_object("participants") %>%
  gather_array("participants.index") %>%
  spread_values(participantId = jnumber("participantId"),
                teamId = jnumber("teamId")) %>%
  enter_object("timeline")

participants.creeps <- participants.timeline %>% 
  enter_object("creepsPerMinDeltas") %>%
  gather_keys("ParticipantTimelineData") %>%
  append_values_number("creepsPerMinDeltas")

participants.gold <- participants.timeline %>% 
  enter_object("goldPerMinDeltas") %>%
  gather_keys("ParticipantTimelineData") %>%
  append_values_number("goldPerMinDeltas")

# participants.wards <- participants.timeline %>% 
#   enter_object("wardsPerMinDeltas") %>%
#   gather_keys("ParticipantTimelineData") %>%
#   append_values_number("ParticipantTimelineValue")

participants.xp <- participants.timeline %>% 
  enter_object("xpPerMinDeltas") %>%
  gather_keys("ParticipantTimelineData") %>%
  append_values_number("xpPerMinDeltas")

# participants.kills <- participants.timeline %>% 
#   enter_object("assistedLaneKillsPerMinDeltas") %>%
#   gather_keys("ParticipantTimelineData") %>%
#   append_values_number("assistedLaneKillsPerMinDeltas")

participants <- merge(participants.creeps, participants.gold)
participants <- merge(participants, participants.xp)

participants <- merge(participants, match.winner) %>%
  select(matchId, teamId, ParticipantTimelineData, creepsPerMinDeltas, goldPerMinDeltas, xpPerMinDeltas, winner) %>%
  group_by(matchId, teamId, ParticipantTimelineData, winner) %>%
  summarise_each(funs(mean)) %>%
  filter(ParticipantTimelineData == "zeroToTen" | ParticipantTimelineData == "tenToTwenty") %>%
  as.data.frame() %>%
  select(-ParticipantTimelineData) %>%
  group_by(matchId, teamId, winner) %>%
  summarise_each(funs(mean))

#       matchId teamId winner creepsPerMinDeltas goldPerMinDeltas xpPerMinDeltas
#         (dbl)  (dbl)  (lgl)              (dbl)            (dbl)          (dbl)
# 1  2054994176    100  FALSE               3.66           270.78         359.19
# 2  2054994176    200   TRUE               4.15           320.34         387.32
# 3  2054994196    100  FALSE               3.55           318.21         402.64
# 4  2054994196    200   TRUE               4.08           332.82         385.74
# 5  2054994244    100  FALSE               3.27           255.12         372.72
# 6  2054994244    200   TRUE               4.10           329.23         424.98
# 7  2054994283    100  FALSE               3.54           255.87         364.14
# 8  2054994283    200   TRUE               4.52           336.31         415.82
# 9  2054994354    100  FALSE               3.78           304.94         358.04
# 10 2054994354    200   TRUE               3.41           299.32         378.73
# ..        ...    ...    ...                ...              ...            ...

ggplot(participants, aes(goldPerMinDeltas, xpPerMinDeltas, color = factor(winner), group = factor(winner))) + 
  geom_point(alpha = 0.2, size = 1) +
  geom_density2d(alpha = 1) +
  # stat_density2d() +
  # stat_density2d(aes(alpha = ..density..), geom = "raster", contour = FALSE)
  # geom_bin2d(aes(color = ..count..), binwidth = 5, alpha = 0.5) +
  # stat_bin2d(binwidth = 5, alpha = 0.5) +
  xlab("Gold per min in first 20 min") +
  ylab("Experience per min in first 20 min")
```